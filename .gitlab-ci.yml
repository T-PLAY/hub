# To contribute improvements to CI/CD templates, please follow the Development guide at:
# https://docs.gitlab.com/ee/development/cicd/templates.html
# This specific template is located at:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/C++.gitlab-ci.yml


# using Radium development dedicated image
image: stormirit/radium_dev:latest

#https://docs.gitlab.com/ee/ci/yaml/#extends
.branches_with_ci:
  only:
    - master

stages: 
  # - dep
  # - build
  # - test
  - doc
  # - format

# cache:
#     key: ${CI_COMMIT_REF_SLUG}
#     paths:
#       - build/
cache:
  key: cache
  paths:
    # - apt-cache/ 
    - doxygen-cache/
    # - pip3-cache/
    # - build-gcc-release/
    # - build-clang-debug/
 

# before_script:
  # - rm -r apt-cache
  # - mkdir -pv apt-cache
  # - |-
  #   if [ -e apt-cache ]; then
  #     cp -rT apt-cache/ /;
  #   fi
  #   if [ -e pip3-cache ]; then
  #     cp -rT pip3-cache/ /;
  #   fi
  # - find apt-cache

# dep:
#   stage: dep
#   script:
#     - |-
#       rm -rf build*

#       # rm -rf apt-cache
#       if [ ! -e apt-cache ]; then
#         apt update
#         apt install -y doxygen cmake-format clang-format python3-pip clang libclang-dev

#         mkdir -pv apt-cache/usr/bin/
#         mkdir -pv apt-cache/usr/share/$(basename /usr/share/cmake-*)/Modules
#         mkdir -pv apt-cache/usr/lib/x86_64-linux-gnu/
#         mkdir -pv apt-cache/usr/lib/llvm-11/bin/
#         mkdir -pv apt-cache/usr/lib/llvm-11/lib/
#         # mkdir -pv apt-cache/usr/lib/


#         cp /usr/bin/doxygen apt-cache/usr/bin/   
#         cp /usr/share/cmake-*/Modules/FindDoxygen.cmake apt-cache/usr/share/$(basename /usr/share/cmake-*)/Modules/
#         cp /usr/share/cmake-*/Modules/FindThreads.cmake apt-cache/usr/share/$(basename /usr/share/cmake-*)/Modules/

#         cp /usr/lib/x86_64-linux-gnu/libclang-* apt-cache/usr/lib/x86_64-linux-gnu/
#         cp -ra /usr/lib/llvm-11/lib/* apt-cache/usr/lib/llvm-11/lib/
#         cp /usr/bin/cmake-format apt-cache/usr/bin/
#         # cp /usr/bin/clang-format apt-cache/usr/bin/
#         # cp /usr/bin/clang-format-11 apt-cache/usr/bin/
#         cp /usr/lib/llvm-11/bin/clang-format apt-cache/usr/lib/llvm-11/bin/
#         cp /usr/bin/clang* apt-cache/usr/bin/
#         cp /usr/lib/x86_64-linux-gnu/libpthread* apt-cache/usr/lib/x86_64-linux-gnu/
        
#         cp -ar /usr/lib/python* apt-cache/usr/lib/
#         cp -ar /usr/lib/clang* apt-cache/usr/lib/
#         cp -a /usr/lib/x86_64-linux-gnu/libclang* apt-cache/usr/lib/x86_64-linux-gnu/
#         cp /usr/bin/pip3 apt-cache/usr/bin/
#         cp /usr/bin/pip apt-cache/usr/bin/
#         cp /usr/bin/python3 apt-cache/usr/bin/
#         cp -a /usr/bin/python3.9 apt-cache/usr/bin/
#         cp -r /usr/share/python* apt-cache/usr/share/
#         # cp -r /usr/lib/python3* apt-cache/usr/lib/
        
#         # find apt-cache
#       fi
 
#       rm -rf pip3-cache
#       if [ ! -e pip3-cache ]; then
#         pip3 install breathe sphinx sphinx-sitemap sphinx-rtd-theme
#         # cp -r ~/.local/bin/* apt-cache/bin/
#         mkdir -pv pip3-cache/bin/
#         mkdir -pv pip3-cache/usr/lib/

#         sleep 2
#         # ls /root/.local/bin/
#         ls /usr/local/bin
#         find / -name "sphinx-build"
#         # ls /usr/bin/sphinx*
#         ls /usr/local/bin/
#         # cp /usr/local/bin/sphinx-build pip3-cache/bin/
#         cp -ar /usr/local/lib/python* pip3-cache/usr/lib/
#         # python3 -m site --user-base
#         # ls /root/.local/
#         # ls /usr/local/bin
#         # ls /usr/local/lib
#         # find pip3-cache
#       fi


# artifacts:
#     # key: ${CI_COMMIT_REF_SLUG}
#     expire_in: 30 days
#     paths:
# #      - build/_deps/
#       - build/
      
# build-gcc-release:
#   stage: build
# #  before_script:
# #    - export PATH=$PATH:/opt/Qt/5.10.0/gcc_64/bin
#   script:
#     # - apt update
#     # - apt install -y doxygen
#     - mkdir -p build-gcc-release
#     - cmake -B build-gcc-release -DCMAKE_CXX_COMPILER=g++ -DCMAKE_C_COMPILER=gcc -DCMAKE_BUILD_TYPE=Release -DHUB_ENABLE_TESTS=ON -DHUB_BUILD_DOC=ON
#     # - cmake -B build-gcc-release -DCMAKE_CXX_COMPILER=g++ -DCMAKE_C_COMPILER=gcc -DCMAKE_BUILD_TYPE=Release
#     - cmake --build build-gcc-release --config Release
#     # - cd build

# build-clang-debug:
#   stage: build
# #  before_script:
# #    - export PATH=$PATH:/opt/Qt/5.10.0/gcc_64/bin
#   script:
#     # - apt update
#     # - apt install -y libclang-dev
#     - mkdir -p build-clang-debug
#     - cmake -B build-clang-debug -DCMAKE_CXX_COMPILER=clang++ -DCMAKE_C_COMPILER=clang -DCMAKE_BUILD_TYPE=Debug -DCMAKE_INSTALL_PREFIX=install -DHUB_BUILD_STATIC_LIBRARY=ON -DHUB_ENABLE_EXAMPLES=ON 
#     # - cmake -B build-clang-debug -DCMAKE_CXX_COMPILER=/usr/bin/clang++ -DCMAKE_C_COMPILER=/usr/bin/clang -DCMAKE_BUILD_TYPE=Debug
#     - cmake --build build-clang-debug --config Debug
#     - cmake --install build-clang-debug --config Debug
  
# test:
#   stage: test
#   script:
#     - cd build-gcc-release/tests
#     - ctest -V
# #    - ./runmytests.sh

# doc-doxygen:
#   stage: doc
#   script:
#     # - apt update
#     # - apt install -y doxygen
#     - cmake --build build-gcc-release --target docs
#     - mv build/doc/docs_doxygen/html/ public/
# #    - ./runmytests.sh
#   artifacts:
#     paths:
#     - public
#   # only:
#     # - feature/add-gitlab-pages-support

cache-doxygen:
  stage: doc
  script:
    - |-
      rm -rf doxygen-cache
      if [ ! -e doxygen-cache ]; then
        apt update
        apt install -y doxygen

        mkdir -pv doxygen-cache/usr/bin/
        # mkdir -pv doxygen-cache/usr/share/$(basename /usr/share/cmake-*)/Modules)

        cp /usr/bin/doxygen doxygen-cache/usr/bin/   
        # cp /usr/share/cmake-*/Modules/FindDoxygen.cmake doxygen-cache/usr/share/$(basename /usr/share/cmake-*)/Modules/
      fi

# cache-sphinx:
#   stage: doc
#   script:
#     - |-
#       cp -rT doxygen-cache/ /;

#       rm -rf pip3-cache
#       if [ ! -e pip3-cache ]; then
#         apt update
#         apt install -y python3-pip
       
#         pip3 install breathe sphinx sphinx-sitemap sphinx-rtd-theme
#         # cp -r ~/.local/bin/* apt-cache/bin/
#         mkdir -pv pip3-cache/usr/local/bin/
#         mkdir -pv pip3-cache/usr/lib/
#         mkdir -pv pip3-cache/usr/bin/
#         mkdir -pv pip3-cache/usr/local/lib/
        
#         # mkdir -pv apt-cache/usr/bin/
#         # mkdir -pv apt-cache/usr/share/$(basename /usr/share/cmake-*)/Modules
#         # mkdir -pv apt-cache/usr/lib/x86_64-linux-gnu/
#         # mkdir -pv apt-cache/usr/lib/llvm-11/bin/
#         # mkdir -pv apt-cache/usr/lib/llvm-11/lib/

#         cp -ar /usr/lib/python* pip3-cache/usr/lib/
#         # cp -ar /usr/lib/clang* apt-cache/usr/lib/
#         # cp -a /usr/lib/x86_64-linux-gnu/libclang* apt-cache/usr/lib/x86_64-linux-gnu/
#         # cp /usr/bin/pip3 apt-cache/usr/bin/
#         # cp /usr/bin/pip apt-cache/usr/bin/
#         cp -a /usr/bin/python* pip3-cache/usr/bin/
#         # cp -a /usr/bin/python3.9 pip3-cache/usr/bin/

#         # cp -r /usr/share/python* apt-cache/usr/share/
#              # cp -r /usr/lib/python3* apt-cache/usr/lib/
#         # ls /root/.local/bin/
#         # ls /usr/local/bin
#         # ls /usr/bin/sphinx*
#         # ls /usr/local/bin/
#         cp /usr/local/bin/sphinx-build pip3-cache/usr/local/bin/
#         # ls -la /usr/local/bin/sphinx-build
#         cp -ar /usr/local/lib/python* pip3-cache/usr/local/lib/
#         # cp -ar /usr/local/lib/python* pip3-cache/usr/lib/
#         # python3 -m site --user-base

#         # ls /root/.local/
#         # ls /usr/local/bin
#         # ls /usr/local/lib
#         # find pip3-cache
#         find / -name "sphinx-build"

#       fi


# doc-sphinx:
#   stage: doc
#   script:
#     - |-
#       cp doxygen-cache/ /;
#       cp -rT pip3-cache/ /;
      
#       ls -la /usr/local/bin/sphinx-build
#       find / -name "sphinx-build"
#       echo $PATH

#       # /usr/local/bin/sphinx-build

#       make -C doc/docs_sphinx html
#       mv doc/docs_sphinx/_build/html public/
#   artifacts:
#     paths:
#       - public
#   # only:
#   # - master


# format:
#   stage: format
#   script:
#     - scripts/cleanup-project.sh
#     - git diff --exit-code
#   only:
#   - master


